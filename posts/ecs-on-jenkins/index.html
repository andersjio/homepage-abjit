<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>ECS on Jenkins - ABJ IT</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://abjit.dkfavicon.png><link rel=stylesheet href=/css/style.min.3d15e334ed03ac1ec07aa0b54c66556810eb6f7def0f9a67747ae9bc85c840aa.css><meta name=description content="Using ECS labels in Jenkinsfiles"><meta property="og:title" content="ECS on Jenkins"><meta property="og:type" content="website"><meta property="og:url" content="https://abjit.dk/posts/ecs-on-jenkins/"><meta property="og:image" content="https://abjit.dk/images/ecs-jenkins-logo.png"><meta property="og:description" content="Using ECS labels in Jenkinsfiles"><meta name=twitter:card content="summary"><meta name=twitter:site content="@"><meta name=twitter:creator content="@"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel=stylesheet></head><body class='page page-blog-single'><div id=menu-main-mobile class=menu-main-mobile><ul class=menu><li class=menu-item-about><a href=https://abjit.dk/pages/about/>About</a></li><li class=menu-item-cv><a href=https://abjit.dk/pages/cv/>CV</a></li><li class=menu-item-posts><a href=https://abjit.dk/posts/>Posts</a></li></ul></div><div id=wrapper class=wrapper><div class=header><a class=header-logo href=https://abjit.dk>ABJ IT</a><div class=menu-main><ul><li class=menu-item-about><a href=/pages/about/>About</a></li><li class=menu-item-cv><a href=/pages/cv/>CV</a></li><li class=menu-item-posts><a href=/posts/>Posts</a></li></ul></div><div id=toggle-menu-main-mobile class=hamburger-trigger><button class=hamburger>Menu</button></div></div><div class=blog><div class=author><img width=30 class=author-image src=/images/author.jpg>
<span class=author-name>Anders B. JÃ¸rgensen</span>
<span class=author-divider></span>
<span class=author-date>August 17, 2023</span></div><div class=intro><h1>ECS on Jenkins</h1><img src=/images/ecs-jenkins-logo.png></div><div class=content><h1 id=motivation>Motivation</h1><p>Researching different ways to improve stability and performance for the builds running on Jenkins , we decided to give AWS Elastic Container Service (ECS) a try.</p><p>This would enable the (re)use of Docker containers, but running on dedicated AWS hardware instead of some of on-premise infrastructure.</p><p>The setup of ECS in Jenkins was pretty straightforward following this <a href=https://aws.amazon.com/blogs/devops/set-up-a-build-pipeline-with-jenkins-and-amazon-ecs/>guide</a> and using this Jenkins <a href=https://plugins.jenkins.io/amazon-ecs/>plugin</a>.</p><p>We quickly realized that adding ECS labels inside Jenkins would quickly grow to something unmanageable and at the same it had to be done by hand, because Jenkins Configuration as Code wasn&rsquo;t used.
The configuration page for Jenkins looked like this but required a lot of scrolling getting to the proper label and place</p><p><img src=/images/ecs-jenkins-settings.png alt=ecs-jenkins-settings></p><h1 id=problem>Problem</h1><p>To avoid the cluttered Jenkins configuration page we wanted to be able to configure CPU, Memory and Docker image inside our Jenkinsfile directly in the pipelines.
This would allow to create a few ECS labels inside of the ECS configuration page in Jenkins and then re-use those labels in mutiple Jenkinsfiles but each with a custom Docker image.</p><p>Luckily that options is available in the plugin, detailed in the plugin section <a href=https://plugins.jenkins.io/amazon-ecs/#plugin-content-usage>here</a>
<img src=/images/ecs-plugin-settings.png alt="Jenkins ECS plugin settings"></p><p>Out-of-box this isn&rsquo;t supported and have to be enabled inside the ECS Jenkins configuration page as detailed <a href=https://plugins.jenkins.io/amazon-ecs/#plugin-content-declarative-pipeline>here</a>:</p><p><em>If you want to override the label, ensure that you are not going to conflict with other labels configured elsewhere. Templates for dynamic agents exist until the agent dies, meaning other jobs requesting the same label (including dynamic agents on other runs of the same job!) run the chance of provisioning the dynamic agent&rsquo;s ECSTask.</em></p><p><em>Note: You have to configure list of settings to be allowed in the declarative pipeline first (see the Allowed Overrides setting). They are disabled by default for security reasons, to avoid non-privileged users to suddenly be able to change certain settings.</em></p><p>Which caused this error in Jenkins:
<img src=/images/ecs-jenkins-failure.png alt="Jenkins ECS failure"></p><p>But I couldn&rsquo;t find where to actually apply these settings. According to (this)[https://github.com/jenkinsci/amazon-ecs-plugin/issues/128] Github issue the labels that needs to be overridden should be added explicitly.</p><h1 id=solution>Solution</h1><p>After spending some time trying to find a description or image on how to add these labels, I found it after clicking around in the Jenkins UI.</p><ul><li>Go to: <a href=https://jenkins.example.com/manage/configureClouds/>https://jenkins.example.com/manage/configureClouds/</a></li><li>Click <em>Show More</em> on the &ldquo;Amazon EC2 Container Service Cloud&rdquo; label that you want to enable this for</li><li>Click on <em>Advanced</em></li><li>Add the desired labels in the field called <em>Allowed declarative settings</em></li></ul><p><img src=/images/ecs-enable-jenkins-labels.png alt="Enable Jenkins labels in ECS"></p><p>That allowed this pipeline to work</p><p><img src=/images/ecs-jenkins-pipeline.png alt="Jenkins ECS pipeline"></p><p>Hopefully, this saves you the time I spend figuring this out!</p></div></div><div class=footer style=text-align:center><div class=footer-social><span class="social-icon social-icon-github"><a href=https://github.com/andersjio title=github target=_blank rel=noopener><img src=/images/social/github.svg width=24 height=24 alt=github></a></span>
<span class="social-icon social-icon-linkedin"><a href=https://www.linkedin.com/in/andersbjorgensen/ title=linkedin target=_blank rel=noopener><img src=/images/social/linkedin.svg width=24 height=24 alt=linkedin></a></span></div></div></div><script type=text/javascript src=/js/bundle.min.5993fcb11c07dea925a3fbd58c03c7f1857197c35fccce3aa963a12c0b3c9960.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y09B98XSRM"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Y09B98XSRM")</script></body></html>